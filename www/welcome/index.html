<!DOCTYPE html>
<html lang="en">
<head>
    <title>Homely | Your home on the web</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="homely, personalised, homepage"/>
    <meta name="description" content="Homely is a personalised homepage built for you that self-updates throughout your day."/>
    <link type="image/x-icon" rel="shortcut icon" href="/images/favicon.ico">
    <link href="/css/welcome.css" type="text/css" rel="stylesheet" />
    <link href="/css/general.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/config.js"></script>
    <script type="text/javascript" src="/js/hello.all.min-1.10.0.js"></script>
    <script type="text/javascript" src="/js/jquery-2.2.0.min.js"></script>
    <script>
        function changeState(newstate) {
            var signinElement = $('#signin');
            var signedinElement = $('#signedin');
            var signinloadingElement = $('#signinloading');
            switch (newstate) {
                case 'loading':
                    signinElement.hide();
                    signedinElement.hide();
                    signinloadingElement.show();
                    break;
                case 'signedin':
                    signinElement.hide();
                    signedinElement.show();
                    signinloadingElement.hide();
                    break;
                case 'notsignedin':
                default:
                    signinElement.show();
                    signedinElement.hide();
                    signinloadingElement.hide();
                    break;
            }
        }
        function userOnline(authResponse) {
            if (!authResponse) return false;
            var currentTime = (new Date()).getTime() / 1000;
            return authResponse && authResponse.access_token && authResponse.expires > currentTime;
        }
        $(document).ready(function() {
            if (userOnline(hello('google').getAuthResponse()) || userOnline(hello('windows').getAuthResponse())) {
                changeState('loading');
            } else {
                changeState('notsignedin');
            }
        });
        hello.init({
            google: CONFIG.OAUTH_GOOGLE_ID,
            windows: CONFIG.OAUTH_WINDOWS_ID
        }, {redirect_uri: '/', force: null});
        hello.on('auth.login', function(auth) {
            hello(auth.network).api('/me').then(function(r) {
                changeState('signedin');
                $('#signedin-text').text((r.name)? r.name: 'Enter');
                $('#signedin-subtext').text((r.name)? 'Not '+r.name+'?': 'Not this user?');
                // check windows or google responses for user picture
                // this boolean logic checks to see if each property is defined as well.
                var pictureUrl = r.picture || (r.image && r.image.url);
                if (pictureUrl) {
                    // only set the picture if it was found.
                    $('#signedin-img').attr("src", pictureUrl);
                } else {
                    // Remove the element completely from the DOM
                    $('#signedin-img').remove();
                }
            }, function() {
                // Error signing in
                changeState('notsignedin');
            });
        });
        function helloLogin (network) {
            hello(network).login();
        }
        function helloLogout () {
            // log out and reload welcome page
            hello('windows').logout();
            hello('google').logout();
            window.location.replace('/welcome');
        }
    </script>
</head>
<body class="full-bg">
    <div id="welcome" class="section-surround">
        <div class="hi">
            <h1>HOMELY</h1>
            <h3>Your home on the web</h3>
            <h3 data-bind="text: loggedIn"></h3>
            <div id="signin" class="login-wrapper">
                <button class="login" onclick="helloLogin('google')">
                    <img src="/images/google_signin.svg" height="50" width="50">
                    <span>Sign in with Google</span>
                </button>
                <button class="login" onclick="helloLogin('windows')">
                    <img src="/images/microsoft_signin.svg" height="50" width="50">
                    <span>Sign in with Microsoft</span>
                </button>
            </div>
            <div id="signedin" class="login-wrapper">
                <button class="login" onclick="location.href='/'">
                    <img id="signedin-img" height="70" width="70">
                    <span id="signedin-text">Enter</span>
                </button>
                <button class="login" onclick="helloLogout()">
                    <span id="signedin-subtext">Not this user?</span>
                </button>
            </div>
            <div id="signinloading" class="login-wrapper">
                <button class="login">
                    <span>Loading...</span>
                </button>
            </div>
        </div>
    </div>
    <footer>
        <span>Â© Homely 2016</span>
    </footer>
</body>
</html>